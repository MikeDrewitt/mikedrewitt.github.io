THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0;this.renderOrder=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.v3=new THREE.RenderableVertex();this.normalModel=new THREE.Vector3();this.vertexNormalsModel=[new THREE.Vector3(),new THREE.Vector3(),new THREE.Vector3()];this.vertexNormalsLength=0;this.color=new THREE.Color();this.material=null;this.uvs=[new THREE.Vector2(),new THREE.Vector2(),new THREE.Vector2()];this.z=0;this.renderOrder=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3();this.positionWorld=new THREE.Vector3();this.positionScreen=new THREE.Vector4();this.visible=true};THREE.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld);this.positionScreen.copy(a.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.vertexColors=[new THREE.Color(),new THREE.Color()];this.material=null;this.z=0;this.renderOrder=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2();this.material=null;this.renderOrder=0};THREE.Projector=function(){var Q,C,J=[],n=0,v,c,f=[],b=0,l,A,F=[],x=0,i,M,O=[],t=0,y,q,e=[],P=0,H={objects:[],lights:[],elements:[]},I=new THREE.Vector3(),G=new THREE.Vector4(),r=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),R=new THREE.Box3(),L=new Array(3),K=new Array(4),a=new THREE.Matrix4(),g=new THREE.Matrix4(),z,B=new THREE.Matrix4(),o=new THREE.Matrix3(),N=new THREE.Frustum(),s=new THREE.Vector4(),h=new THREE.Vector4();this.projectVector=function(S,T){console.warn("THREE.Projector: .projectVector() is now vector.project().");S.project(T)};this.unprojectVector=function(S,T){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");S.unproject(T)};this.pickingRay=function(S,T){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var d=function(){var ae=[];var aa=[];var Z=null;var ac=null;var Y=new THREE.Matrix3();function W(ag){Z=ag;ac=Z.material;Y.getNormalMatrix(Z.matrixWorld);ae.length=0;aa.length=0}function ab(ai){var ag=ai.position;var aj=ai.positionWorld;var ah=ai.positionScreen;aj.copy(ag).applyMatrix4(z);ah.copy(aj).applyMatrix4(g);var ak=1/ah.w;ah.x*=ak;ah.y*=ak;ah.z*=ak;ai.visible=ah.x>=-1&&ah.x<=1&&ah.y>=-1&&ah.y<=1&&ah.z>=-1&&ah.z<=1}function T(ag,ai,ah){v=u();v.position.set(ag,ai,ah);ab(v)}function V(ag,ai,ah){ae.push(ag,ai,ah)}function U(ag,ah){aa.push(ag,ah)}function X(ai,ah,ag){if(ai.visible===true||ah.visible===true||ag.visible===true){return true}L[0]=ai.positionScreen;L[1]=ah.positionScreen;L[2]=ag.positionScreen;return r.intersectsBox(R.setFromPoints(L))}function ad(ai,ah,ag){return((ag.positionScreen.x-ai.positionScreen.x)*(ah.positionScreen.y-ai.positionScreen.y)-(ag.positionScreen.y-ai.positionScreen.y)*(ah.positionScreen.x-ai.positionScreen.x))<0}function af(ah,ag){var aj=f[ah];var ai=f[ag];i=E();i.id=Z.id;i.v1.copy(aj);i.v2.copy(ai);i.z=(aj.positionScreen.z+ai.positionScreen.z)/2;i.renderOrder=Z.renderOrder;i.material=Z.material;H.elements.push(i)}function S(an,al,aj){var ao=f[an];var am=f[al];var ak=f[aj];if(X(ao,am,ak)===false){return}if(ac.side===THREE.DoubleSide||ad(ao,am,ak)===true){l=k();l.id=Z.id;l.v1.copy(ao);l.v2.copy(am);l.v3.copy(ak);l.z=(ao.positionScreen.z+am.positionScreen.z+ak.positionScreen.z)/3;l.renderOrder=Z.renderOrder;l.normalModel.fromArray(ae,an*3);l.normalModel.applyMatrix3(Y).normalize();for(var ah=0;ah<3;ah++){var ai=l.vertexNormalsModel[ah];ai.fromArray(ae,arguments[ah]*3);ai.applyMatrix3(Y).normalize();var ag=l.uvs[ah];ag.fromArray(aa,arguments[ah]*2)}l.vertexNormalsLength=3;l.material=Z.material;H.elements.push(l)}}return{setObject:W,projectVertex:ab,checkTriangleVisibility:X,checkBackfaceCulling:ad,pushVertex:T,pushNormal:V,pushUv:U,pushLine:af,pushTriangle:S}};var D=new d();this.projectScene=function(ap,ah,ar,W){A=0;M=0;q=0;H.elements.length=0;if(ap.autoUpdate===true){ap.updateMatrixWorld()}if(ah.parent===null){ah.updateMatrixWorld()}a.copy(ah.matrixWorldInverse.getInverse(ah.matrixWorld));g.multiplyMatrices(ah.projectionMatrix,a);N.setFromMatrix(g);C=0;H.objects.length=0;H.lights.length=0;function at(aR){Q=m();Q.id=aR.id;Q.object=aR;I.setFromMatrixPosition(aR.matrixWorld);I.applyProjection(g);Q.z=I.z;Q.renderOrder=aR.renderOrder;H.objects.push(Q)}ap.traverseVisible(function(aR){if(aR instanceof THREE.Light){H.lights.push(aR)}else{if(aR instanceof THREE.Mesh||aR instanceof THREE.Line){if(aR.material.visible===false){return}if(aR.frustumCulled===true&&N.intersectsObject(aR)===false){return}at(aR)}else{if(aR instanceof THREE.Sprite){if(aR.material.visible===false){return}if(aR.frustumCulled===true&&N.intersectsSprite(aR)===false){return}at(aR)}}}});if(ar===true){H.objects.sort(p)}for(var aE=0,av=H.objects.length;aE<av;aE++){var aA=H.objects[aE].object;var ad=aA.geometry;D.setObject(aA);z=aA.matrixWorld;c=0;if(aA instanceof THREE.Mesh){if(ad instanceof THREE.BufferGeometry){var az=ad.attributes;var Z=ad.groups;if(az.position===undefined){continue}var ab=az.position.array;for(var aJ=0,aH=ab.length;aJ<aH;aJ+=3){D.pushVertex(ab[aJ],ab[aJ+1],ab[aJ+2])}if(az.normal!==undefined){var al=az.normal.array;for(var aJ=0,aH=al.length;aJ<aH;aJ+=3){D.pushNormal(al[aJ],al[aJ+1],al[aJ+2])}}if(az.uv!==undefined){var ay=az.uv.array;for(var aJ=0,aH=ay.length;aJ<aH;aJ+=2){D.pushUv(ay[aJ],ay[aJ+1])}}if(ad.index!==null){var V=ad.index.array;if(Z.length>0){for(var aE=0;aE<Z.length;aE++){var ak=Z[aE];for(var aJ=ak.start,aH=ak.start+ak.count;aJ<aH;aJ+=3){D.pushTriangle(V[aJ],V[aJ+1],V[aJ+2])}}}else{for(var aJ=0,aH=V.length;aJ<aH;aJ+=3){D.pushTriangle(V[aJ],V[aJ+1],V[aJ+2])}}}else{for(var aJ=0,aH=ab.length/3;aJ<aH;aJ+=3){D.pushTriangle(aJ,aJ+1,aJ+2)}}}else{if(ad instanceof THREE.Geometry){var U=ad.vertices;var ac=ad.faces;var ax=ad.faceVertexUvs[0];o.getNormalMatrix(z);var aI=aA.material;var Y=aI instanceof THREE.MultiMaterial;var am=Y===true?aA.material:null;for(var aB=0,ag=U.length;aB<ag;aB++){var aj=U[aB];I.copy(aj);if(aI.morphTargets===true){var ae=ad.morphTargets;var aG=aA.morphTargetInfluences;for(var aD=0,T=ae.length;aD<T;aD++){var aw=aG[aD];if(aw===0){continue}var S=ae[aD];var ao=S.vertices[aB];I.x+=(ao.x-aj.x)*aw;I.y+=(ao.y-aj.y)*aw;I.z+=(ao.z-aj.z)*aw}}D.pushVertex(I.x,I.y,I.z)}for(var aK=0,aq=ac.length;aK<aq;aK++){var aa=ac[aK];aI=Y===true?am.materials[aa.materialIndex]:aA.material;if(aI===undefined){continue}var af=aI.side;var aQ=f[aa.a];var aO=f[aa.b];var aM=f[aa.c];if(D.checkTriangleVisibility(aQ,aO,aM)===false){continue}var an=D.checkBackfaceCulling(aQ,aO,aM);if(af!==THREE.DoubleSide){if(af===THREE.FrontSide&&an===false){continue}if(af===THREE.BackSide&&an===true){continue}}l=k();l.id=aA.id;l.v1.copy(aQ);l.v2.copy(aO);l.v3.copy(aM);l.normalModel.copy(aa.normal);if(an===false&&(af===THREE.BackSide||af===THREE.DoubleSide)){l.normalModel.negate()}l.normalModel.applyMatrix3(o).normalize();var X=aa.vertexNormals;for(var aF=0,aN=Math.min(X.length,3);aF<aN;aF++){var aP=l.vertexNormalsModel[aF];aP.copy(X[aF]);if(an===false&&(af===THREE.BackSide||af===THREE.DoubleSide)){aP.negate()}aP.applyMatrix3(o).normalize()}l.vertexNormalsLength=X.length;var ai=ax[aK];if(ai!==undefined){for(var aC=0;aC<3;aC++){l.uvs[aC].copy(ai[aC])}}l.color=aa.color;l.material=aI;l.z=(aQ.positionScreen.z+aO.positionScreen.z+aM.positionScreen.z)/3;l.renderOrder=aA.renderOrder;H.elements.push(l)}}}}else{if(aA instanceof THREE.Line){if(ad instanceof THREE.BufferGeometry){var az=ad.attributes;if(az.position!==undefined){var ab=az.position.array;for(var aJ=0,aH=ab.length;aJ<aH;aJ+=3){D.pushVertex(ab[aJ],ab[aJ+1],ab[aJ+2])}if(ad.index!==null){var V=ad.index.array;for(var aJ=0,aH=V.length;aJ<aH;aJ+=2){D.pushLine(V[aJ],V[aJ+1])}}else{var au=aA instanceof THREE.LineSegments?2:1;for(var aJ=0,aH=(ab.length/3)-1;aJ<aH;aJ+=au){D.pushLine(aJ,aJ+1)}}}}else{if(ad instanceof THREE.Geometry){B.multiplyMatrices(g,z);var U=aA.geometry.vertices;if(U.length===0){continue}aQ=u();aQ.positionScreen.copy(U[0]).applyMatrix4(B);var au=aA instanceof THREE.LineSegments?2:1;for(var aB=1,ag=U.length;aB<ag;aB++){aQ=u();aQ.positionScreen.copy(U[aB]).applyMatrix4(B);if((aB+1)%au>0){continue}aO=f[c-2];s.copy(aQ.positionScreen);h.copy(aO.positionScreen);if(w(s,h)===true){s.multiplyScalar(1/s.w);h.multiplyScalar(1/h.w);i=E();i.id=aA.id;i.v1.positionScreen.copy(s);i.v2.positionScreen.copy(h);i.z=Math.max(s.z,h.z);i.renderOrder=aA.renderOrder;i.material=aA.material;if(aA.material.vertexColors===THREE.VertexColors){i.vertexColors[0].copy(aA.geometry.colors[aB]);i.vertexColors[1].copy(aA.geometry.colors[aB-1])}H.elements.push(i)}}}}}else{if(aA instanceof THREE.Sprite){G.set(z.elements[12],z.elements[13],z.elements[14],1);G.applyMatrix4(g);var aL=1/G.w;G.z*=aL;if(G.z>=-1&&G.z<=1){y=j();y.id=aA.id;y.x=G.x*aL;y.y=G.y*aL;y.z=G.z;y.renderOrder=aA.renderOrder;y.object=aA;y.rotation=aA.rotation;y.scale.x=aA.scale.x*Math.abs(y.x-(G.x+ah.projectionMatrix.elements[0])/(G.w+ah.projectionMatrix.elements[12]));y.scale.y=aA.scale.y*Math.abs(y.y-(G.y+ah.projectionMatrix.elements[5])/(G.w+ah.projectionMatrix.elements[13]));y.material=aA.material;H.elements.push(y)}}}}}if(W===true){H.elements.sort(p)}return H};function m(){if(C===n){var S=new THREE.RenderableObject();J.push(S);n++;C++;return S}return J[C++]}function u(){if(c===b){var S=new THREE.RenderableVertex();f.push(S);b++;c++;return S}return f[c++]}function k(){if(A===x){var S=new THREE.RenderableFace();F.push(S);x++;A++;return S}return F[A++]}function E(){if(M===t){var S=new THREE.RenderableLine();O.push(S);t++;M++;return S}return O[M++]}function j(){if(q===P){var S=new THREE.RenderableSprite();e.push(S);P++;q++;return S}return e[q++]}function p(T,S){if(T.renderOrder!==S.renderOrder){return T.renderOrder-S.renderOrder}else{if(T.z!==S.z){return S.z-T.z}else{if(T.id!==S.id){return T.id-S.id}else{return 0}}}}function w(W,V){var U=0,Z=1,X=W.z+W.w,T=V.z+V.w,S=-W.z+W.w,Y=-V.z+V.w;if(X>=0&&T>=0&&S>=0&&Y>=0){return true}else{if((X<0&&T<0)||(S<0&&Y<0)){return false}else{if(X<0){U=Math.max(U,X/(X-T))}else{if(T<0){Z=Math.min(Z,X/(X-T))}}if(S<0){U=Math.max(U,S/(S-Y))}else{if(Y<0){Z=Math.min(Z,S/(S-Y))}}if(Z<U){return false}else{W.lerp(V,U);V.lerp(W,1-Z);return true}}}}};